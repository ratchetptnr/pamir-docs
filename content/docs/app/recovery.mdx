---
title: Recovery Flow
description: Bluetooth-based device recovery with scan fallback
---

import { Callout } from 'fumadocs-ui/components/callout'
import { Mermaid } from '@/components/mermaid'

<Callout title="Product Philosophy">
  **Recovery should be simple.** When a device loses WiFi, the user's phone becomes the rescue tool. The path back should be direct—try auto-reconnect first, offer manual pairing as a fallback. One path, no branching.
</Callout>

The recovery flow reconnects a known device to WiFi using Bluetooth as the communication channel. It is **self-contained**—a dedicated `RecoveryView` sheet that does not reuse the onboarding flow. This keeps the recovery experience focused and avoids flashing through irrelevant onboarding screens.

---

## Single-Path Design

Recovery always starts with a QR scanner. If the phone already has a BLE connection to the device (iOS remembered it), the scanner auto-advances to WiFi setup. Otherwise, the user scans the QR code on the device's e-ink display.

| Scenario | What Happens |
| :--- | :--- |
| **Phone remembers the device** | Scanner opens, BLE auto-connects, advances to WiFi setup |
| **Phone doesn't remember** | User scans QR code → BLE connects → WiFi setup |
| **Device belongs to another account** | "This Distiller is not registered to your account" → dismiss |

---

## The Recovery Journey

<Mermaid chart={`
flowchart TD
    Start([Device Offline]) --> Tap["User taps 'Recover via Bluetooth'"]

    Tap --> Scan[QR Scanner Sheet]

    Scan --> AutoConnect{Phone remembers\ndevice?}
    AutoConnect -->|Yes| WiFiList[WiFi Network List]
    AutoConnect -->|No| UserScan[User scans QR / enters code]

    UserScan --> AccountCheck{Device on\nsame account?}
    AccountCheck -->|Yes| WiFiList
    AccountCheck -->|No| Denied[Not your Distiller] --> End([Dismiss])

    UserScan --> ScanFailed[Connection failed]
    ScanFailed -->|Scan again| UserScan

    WiFiList --> EnterPass[WiFi password sheet]
    EnterPass --> WiFiResult{WiFi Connection}

    WiFiResult -->|Wrong Password| PassError[Inline error]
    PassError --> EnterPass

    WiFiResult -->|Timeout| TimeoutAlert[Connection Timed Out]
    TimeoutAlert -->|Try Again| EnterPass
    TimeoutAlert -->|Different Network| WiFiList

    WiFiResult -->|Success| Done([Sheet dismisses — device online])

    style Start fill:#ffebee
    style Done fill:#e1f5e1
    style End fill:#fff4e6
    style Denied fill:#ffebee
    style PassError fill:#ffebee
    style TimeoutAlert fill:#ffebee
    style ScanFailed fill:#ffebee
    style Scan fill:#e3f2fd
`} />

### Step 1: QR Scan

The recovery sheet opens with a QR scanner — same pairing screen as onboarding and add-device, with an X button to dismiss. If the phone already has a BLE connection to the device (iOS remembered it), the scanner auto-advances to WiFi setup.

<div className="flex justify-center my-8">
  <img
    src="/docs/ios/recovery-pairing.png"
    alt="Recovery QR scanner"
    className="w-full max-w-[320px] rounded-2xl border shadow-xl"
  />
</div>

**Account validation:** When the phone connects to a Distiller, the app checks whether the device belongs to the signed-in account. If not, the user sees "This Distiller is not registered to your account" and can only dismiss. The user can scan any of their offline devices — recovery is not locked to the specific device they tapped on.

### Step 2: WiFi Setup

Once BLE is established, the device scans for nearby networks. Same WiFi list, password sheet, and connection results as onboarding.

<div className="flex justify-center my-8">
  <img
    src="/docs/ios/recovery-wifi-list.png"
    alt="WiFi network selection during recovery"
    className="w-full max-w-[320px] rounded-2xl border shadow-xl"
  />
</div>

On successful WiFi connection, the recovery sheet dismisses automatically — no completion screen.

---

## Architecture: Separate from Onboarding

Recovery is a **self-contained flow** with its own state machine. It does not reuse `OnboardingView` or `OnboardingStore`.

| Component | Onboarding | Recovery |
| :--- | :--- | :--- |
| **View** | `OnboardingView` | `RecoveryView` |
| **Store** | `OnboardingStore` | `RecoveryStore` |
| **Completion** | `SetupCompleteView` | `RecoveryCompleteView` (inline) |
| **Navigation** | `NavigationStack` + full step enum | `NavigationStack` + lightweight step enum |

This separation exists because recovery and onboarding have fundamentally different responsibilities:

- Onboarding handles auth, device discovery, pairing, WiFi setup, and completion
- Recovery handles BLE reconnect, optional scan fallback, WiFi setup, and a simple "back online" confirmation

Sharing a view forced recovery through irrelevant states (Welcome screen flash, device selection) and made error handling brittle.

### RecoveryStore Steps

```swift
enum Step: Hashable {
    case scanning       // QR / code pairing (entry point)
    case wifiList       // Select WiFi network
    case wifiConnecting // Connecting to WiFi
    // No completion step — sheet dismisses on WiFi success
}
```

---

## Entry Points

Recovery is triggered through the [Offline UX](/docs/app/offline-ux) alert system. When a device is offline and the user attempts a blocked action (send message, create project, etc.), an alert appears with a "Recover via Bluetooth" CTA that launches the recovery sheet.

<div className="flex justify-center my-8">
  <img
    src="/docs/ios/alert-device-offline.png"
    alt="Device offline alert with Recover via Bluetooth button"
    className="w-full max-w-[320px] rounded-2xl border shadow-xl"
  />
</div>

There are three paths into recovery:

1. **Device Offline Alert** — User taps a blocked action → alert shows "Recover via Bluetooth" → launches `RecoveryView` sheet
2. **Device Menu** — User taps an offline device in the device selector dropdown → recovery starts for that device
3. **Settings** — When the active device is offline, a standalone offline banner appears at the top of Settings (between the Account card and the Connectivity section). Tapping it launches the `RecoveryView` sheet

<div className="flex justify-center my-8">
  <img
    src="/docs/ios/settings-device-offline.png"
    alt="Settings screen showing offline device banner between Account card and Connectivity section"
    className="w-full max-w-[320px] rounded-2xl border shadow-xl"
  />
</div>

All paths present the same `RecoveryView` sheet with the device name, ensuring a consistent experience. See [Offline UX](/docs/app/offline-ux) for the full alert system, visual indicators, and action availability matrix.

---

## Error Handling

### Bluetooth Connection Failed

The device may be out of range, powered off, or experiencing hardware issues.

<div className="flex justify-center my-8">
  <img
    src="/docs/ios/recovery-error-ble.png"
    alt="Bluetooth connection failed error"
    className="w-full max-w-[320px] rounded-2xl border shadow-xl"
  />
</div>

- **Message**: "Couldn't Connect" with guidance to check power and proximity
- **Options**: Try Again, Scan QR Code, or Cancel
- **Scan fallback**: For phones that have never paired with this device, scanning is the path forward

### WiFi Authentication Failed

Wrong password entered.

- **Message**: "Incorrect password. Please try again."
- **Behavior**: Inline error in the password sheet; password field clears and refocuses
- **Guidance**: After two attempts, remind that passwords are case-sensitive

### WiFi Connection Timeout

The device couldn't join the network within the expected time.

- **Message**: "Couldn't connect to [Network Name]"
- **Options**: Try Again or Choose Different Network
- **Guidance**: Network may be unavailable or signal too weak

---

## Design Principles

1. **Try Fast, Fall Back Gracefully**: Auto-reconnect first, scan fallback always available—no branching logic
2. **Self-Contained**: Recovery has its own view and store, independent of onboarding
3. **Skip What's Known**: Device identity and security are already established—don't repeat them
4. **Same WiFi Flow**: Once connected via Bluetooth, WiFi setup is identical to onboarding
5. **Escape Hatches at Every Stage**: Scan link during reconnecting, scan option on failure, cancel always available
6. **Graceful Failure**: Every error has a retry option and clear messaging
