---
title: Recovery Flow
description: Bluetooth-based device recovery with scan fallback
---

import { Callout } from 'fumadocs-ui/components/callout'
import { Mermaid } from '@/components/mermaid'

<Callout title="Product Philosophy">
  **Recovery should be simple.** When a device loses WiFi, the user's phone becomes the rescue tool. The path back should be direct—try auto-reconnect first, offer manual pairing as a fallback. One path, no branching.
</Callout>

The recovery flow reconnects a known device to WiFi using Bluetooth as the communication channel. It is **self-contained**—a dedicated `RecoveryView` sheet that does not reuse the onboarding flow. This keeps the recovery experience focused and avoids flashing through irrelevant onboarding screens.

---

## Single-Path Design

Recovery always starts with automatic BLE reconnection. If that fails—or if the user wants to skip the wait—a QR/code scan fallback is available at every stage.

This avoids branching logic. The system doesn't need to know whether this phone has previously connected to the device. It just tries the fast path first and offers the manual path as an escape hatch.

| Scenario | What Happens |
| :--- | :--- |
| **Phone knows the device** | Auto-reconnect succeeds → WiFi setup |
| **Phone doesn't know the device** | Auto-reconnect fails → user taps "Scan QR Code" → WiFi setup |
| **User is impatient** | Taps "Scan QR Code" during reconnecting → WiFi setup |

---

## The Recovery Journey

<Mermaid chart={`
flowchart TD
    Start([Device Offline Alert]) --> Tap["User taps 'Recover via Bluetooth'"]

    Tap --> Connecting[Reconnecting...]
    Connecting --> ScanEscape["'Or scan QR code on device'"]
    ScanEscape -->|User taps| Scan[QR / Code Scan Screen]

    Connecting --> BLEResult{BLE Connection}

    BLEResult -->|Failed| RetryPrompt[Connection failed]
    RetryPrompt --> FailChoice{User choice}
    FailChoice -->|Try Again| Connecting
    FailChoice -->|Scan QR Code| Scan
    FailChoice -->|Cancel| End([Return to app])

    Scan --> ScanConnect[Inline connecting...]
    ScanConnect --> ScanResult{Connected?}
    ScanResult -->|No| ScanFailed[Inline error]
    ScanFailed -->|Try Again| ScanConnect
    ScanFailed -->|Scan Different| Scan
    ScanResult -->|Yes| WiFiList

    BLEResult -->|Success| WiFiList[WiFi Network Selection]

    WiFiList --> SelectNetwork[User selects network]
    SelectNetwork --> EnterPass[Enter WiFi password]
    EnterPass --> Sending[Sending credentials...]

    Sending --> WiFiResult{WiFi Connection}

    WiFiResult -->|Wrong Password| PassError[Password incorrect]
    PassError --> EnterPass

    WiFiResult -->|Timeout| TimeoutError[Connection failed]
    TimeoutError --> TimeoutChoice{User choice}
    TimeoutChoice -->|Try Again| Sending
    TimeoutChoice -->|Different Network| WiFiList

    WiFiResult -->|Success| Complete[Recovery Complete]
    Complete --> Done([Device back online])

    style Start fill:#ffebee
    style Done fill:#e1f5e1
    style Complete fill:#d4edff
    style End fill:#fff4e6
    style RetryPrompt fill:#ffebee
    style PassError fill:#ffebee
    style TimeoutError fill:#ffebee
    style Scan fill:#e3f2fd
    style ScanEscape fill:#e3f2fd
`} />

### Step 1: Reconnecting

The app immediately attempts to establish a Bluetooth connection with the known device. The user sees a "Connecting via Bluetooth..." spinner with the device name.

Below the spinner, a **"Or scan QR code on device"** link is always visible. This is the early escape hatch—users don't have to wait for failure to reach the scanner.

<div className="flex justify-center my-8">
  <img
    src="/docs/ios/recovery-reconnecting.png"
    alt="Reconnecting spinner state with scan QR code link"
    className="w-full max-w-[320px] rounded-2xl border shadow-xl"
  />
</div>

### Step 1b: Scan Fallback (if needed)

If auto-reconnect fails or the user taps the scan link, they see a QR/code scan screen—the same dark-background pairing experience as onboarding, but using the recovery flow's own state machine.

- **QR viewfinder** — point at the device's QR code
- **4-digit code entry** — manual fallback with a Connect button
- **Inline connecting/failed states** — no navigation away; errors resolve in-place

This screen is identical in visual language to the onboarding `DevicePairingView` but is self-contained within the recovery sheet.

### Step 2: WiFi Selection

Once Bluetooth is established (via auto-reconnect or scan), the device reports available WiFi networks. The user selects a network. The back button is hidden since going back to the reconnecting spinner is meaningless—Cancel in the toolbar dismisses the sheet.

<div className="flex justify-center my-8">
  <img
    src="/docs/ios/recovery-wifi-list.png"
    alt="WiFi network selection during recovery"
    className="w-full max-w-[320px] rounded-2xl border shadow-xl"
  />
</div>

### Step 3: Credential Entry

The user enters the WiFi password in a bottom sheet. The app sends credentials via Bluetooth to the device.

<div className="flex justify-center my-8">
  <img
    src="/docs/ios/recovery-wifi-password.png"
    alt="WiFi password entry screen"
    className="w-full max-w-[320px] rounded-2xl border shadow-xl"
  />
</div>

### Step 4: Completion

On success, the user sees a "Back Online" screen with a checkmark animation and the device name. Tapping "Done" dismisses the recovery sheet.

<div className="flex justify-center my-8">
  <img
    src="/docs/ios/recovery-complete.png"
    alt="Recovery complete screen showing device back online"
    className="w-full max-w-[320px] rounded-2xl border shadow-xl"
  />
</div>

---

## Architecture: Separate from Onboarding

Recovery is a **self-contained flow** with its own state machine. It does not reuse `OnboardingView` or `OnboardingStore`.

| Component | Onboarding | Recovery |
| :--- | :--- | :--- |
| **View** | `OnboardingView` | `RecoveryView` |
| **Store** | `OnboardingStore` | `RecoveryStore` |
| **Completion** | `SetupCompleteView` | `RecoveryCompleteView` (inline) |
| **Navigation** | `NavigationStack` + full step enum | `NavigationStack` + lightweight step enum |

This separation exists because recovery and onboarding have fundamentally different responsibilities:

- Onboarding handles auth, device discovery, pairing, WiFi setup, and completion
- Recovery handles BLE reconnect, optional scan fallback, WiFi setup, and a simple "back online" confirmation

Sharing a view forced recovery through irrelevant states (Welcome screen flash, device selection) and made error handling brittle.

### RecoveryStore Steps

```swift
enum Step: Hashable {
    case reconnecting   // Root: auto-connect via BLE
    case failed         // BLE connection failed
    case scanning       // QR / code pairing fallback
    case wifiList       // Select WiFi network
    case wifiConnecting // Connecting to WiFi
    case complete       // Done — device is back online
}
```

---

## Entry Points

Recovery is triggered through the [Offline UX](/docs/app/offline-ux) alert system. When a device is offline and the user attempts a blocked action (send message, create project, etc.), an alert appears with a "Recover via Bluetooth" CTA that launches the recovery sheet.

<div className="flex justify-center my-8">
  <img
    src="/docs/ios/alert-device-offline.png"
    alt="Device offline alert with Recover via Bluetooth button"
    className="w-full max-w-[320px] rounded-2xl border shadow-xl"
  />
</div>

There are three paths into recovery:

1. **Device Offline Alert** — User taps a blocked action → alert shows "Recover via Bluetooth" → launches `RecoveryView` sheet
2. **Device Menu** — User taps an offline device in the device selector dropdown → recovery starts for that device
3. **Settings** — Offline device row in the Connectivity section → tapping launches recovery *(planned — not yet re-implemented)*

All paths present the same `RecoveryView` sheet with the device name, ensuring a consistent experience. See [Offline UX](/docs/app/offline-ux) for the full alert system, visual indicators, and action availability matrix.

---

## Error Handling

### Bluetooth Connection Failed

The device may be out of range, powered off, or experiencing hardware issues.

<div className="flex justify-center my-8">
  <img
    src="/docs/ios/recovery-error-ble.png"
    alt="Bluetooth connection failed error"
    className="w-full max-w-[320px] rounded-2xl border shadow-xl"
  />
</div>

- **Message**: "Couldn't Connect" with guidance to check power and proximity
- **Options**: Try Again, Scan QR Code, or Cancel
- **Scan fallback**: For phones that have never paired with this device, scanning is the path forward

### WiFi Authentication Failed

Wrong password entered.

- **Message**: "Incorrect password. Please try again."
- **Behavior**: Inline error in the password sheet; password field clears and refocuses
- **Guidance**: After two attempts, remind that passwords are case-sensitive

### WiFi Connection Timeout

The device couldn't join the network within the expected time.

- **Message**: "Couldn't connect to [Network Name]"
- **Options**: Try Again or Choose Different Network
- **Guidance**: Network may be unavailable or signal too weak

---

## Design Principles

1. **Try Fast, Fall Back Gracefully**: Auto-reconnect first, scan fallback always available—no branching logic
2. **Self-Contained**: Recovery has its own view and store, independent of onboarding
3. **Skip What's Known**: Device identity and security are already established—don't repeat them
4. **Same WiFi Flow**: Once connected via Bluetooth, WiFi setup is identical to onboarding
5. **Escape Hatches at Every Stage**: Scan link during reconnecting, scan option on failure, cancel always available
6. **Graceful Failure**: Every error has a retry option and clear messaging
