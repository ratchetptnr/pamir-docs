---
title: Bluetooth (Outdated)
description: Bluetooth Architecture & Philosophy - Superseded by State Machine docs
---

import { Callout } from 'fumadocs-ui/components/callout'
import { Mermaid } from '@/components/mermaid'

<Callout type="warn" title="⚠️ Outdated Documentation">
  This page is outdated and superseded by the [State Machine](/docs/connectivity/state-machine) architecture. Please refer to the State Machine docs for current connectivity implementation.
</Callout>

<Callout title="Product Philosophy">
  "The Radio has a Split Personality." It must serve two masters: the **System** (for survival/recovery) and the **User** (for connecting peripherals). The architecture manages this conflict seamlessly without user intervention.
</Callout>

## State Machine

The Bluetooth radio transitions between states based on device status and user actions.

<Mermaid chart={`
flowchart LR
    subgraph "Bluetooth Radio States"
    Off["Radio Off"]
    Hidden["Hidden (On, Not Discoverable)"]
    Discoverable["Discoverable (Pairing Mode)"]
    Connected["Connected"]
    end
    
    Off -->|"Device Boot"| Hidden
    Off -->|"Wi-Fi Lost + Force Recovery"| Discoverable
    Hidden -->|"Wi-Fi Lost > 30s"| Discoverable
    Hidden -->|"User Taps 'Enable Pairing'"| Discoverable
    Discoverable -->|"Paired Successfully"| Connected
    Discoverable -->|"Timeout 60s"| Hidden
    Connected -->|"Disconnected"| Hidden
    Connected -->|"Wi-Fi Restored"| Hidden
`} />

---

## Recovery Flow (Wi-Fi Loss)

When Wi-Fi dies, the radio automatically enables discovery mode to allow app-based recovery.

<Mermaid chart={`
flowchart TD
    Online["Device Online (Wi-Fi OK)"] --> WifiLost{"Wi-Fi Lost?"}
    WifiLost -->|No| Online
    WifiLost -->|Yes| Scanning["Scanning for Known Networks"]
    Scanning --> Found{"Found Known SSID?"}
    Found -->|Yes| Online
    Found -->|"No (30s timeout)"| EnableBLE["Auto-Enable BLE Discovery"]
    EnableBLE --> ShowQR["E-ink: Show QR + 'Offline'"]
    ShowQR --> AppConnect["App Connects via BLE"]
    AppConnect --> Authenticate{"Registered Account OK?"}
    Authenticate -->|No| Reject["Reject Command"]
    Reject --> AppConnect
    Authenticate -->|Yes| ProvisionWiFi["App Sends New Wi-Fi Creds"]
    ProvisionWiFi --> Connecting["Attempting Wi-Fi Join"]
    Connecting --> Success{"Success?"}
    Success -->|Yes| DisableBLE["Disable BLE Discovery"]
    DisableBLE --> Online
    Success -->|No| ShowError["Show Error, Retry"]
    ShowError --> ProvisionWiFi
    
    classDef recovery fill:#e3f2fd,stroke:#1565c0,color:#1565c0
    classDef security fill:#ffebee,stroke:#c62828,color:#c62828
    class EnableBLE,ShowQR,AppConnect,ProvisionWiFi recovery
    class Authenticate,Reject security
`} />

---

## 1. System Role: The Invisible Guard

This is the default state of the machine. The radio is powered on but advertising is silent. It waits for a trigger event to enter "Rescue Mode".

**The Trigger**: A "Hard Offline" event (Wi-Fi lost > 30s).
**The Action**: The device automatically becomes **Discoverable**. It flashes a QR code on the E-ink display.
**The Goal**: Allow the Mobile App to find and connect to the device *without* user interaction (no pairing buttons).

## 2. Peripheral Role: The Connector

This is the user-facing side of Bluetooth. When you write code on Distiller to talk to a BLE heart rate monitor, you are using this role.

**The Trigger**: User taps "Enable Pairing Mode" in the Dashboard.
**The Action**: The device scans for nearby peripherals for 60 seconds.
**The Goal**: Enable the "Pocket IDE" experience, allowing the device to physically interact with the world.

---

## Security Model: Trust, but Verify

Bluetooth is inherently promiscuous. Anyone nearby can see a discoverable device. Our security model acknowledges this reality.

### The Handshake (Open)
We allow *anyone* to initiate a BLE connection (the "Handshake"). This ensures that in an emergency, your phone can find the device instantly without struggling with OS-level pairing dialogs.

### The Gatekeeper (Locked)
Once the connection is established, the device is **deaf** to commands until it verifies **Registered Account Ownership**.
- **Can I see the device name?** Yes.
- **Can I change the Wi-Fi?** No (Account Verification Required).
- **Can I reboot it?** No (Account Verification Required).

---

## Golden Rules

These are the immutable laws of the Distiller Bluetooth system.

1.  **Radio is ALWAYS ON**: The user cannot disable Bluetooth via the UI. It is the only path back from a "bricked" state.
2.  **System Trumps User**: If Wi-Fi is lost, the System Role takes over immediately, canceling any active Peripheral scanning. Survival comes first.
3.  **No Physical Reset**: We do not rely on a physical "Reset Button". The BLE-based recovery flow *is* the reset button.
4.  **Timeouts Protect Privacy**: "Discovery Mode" (for peripherals) always times out after 60 seconds. The device never broadcasts its presence indefinitely unless it is in distress.
